#!/bin/bash

# IDOR (Insecure Direct Object Reference) Testing Module
# Tests for access control vulnerabilities through parameter manipulation

source "$(dirname "${BASH_SOURCE[0]}")/../../core/logger.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../../core/database.sh"

# Main IDOR testing function
test_idor() {
    local url=$1
    local project_id=$2

    log_info "Testing IDOR vulnerabilities on $url"

    # Test numeric ID manipulation
    test_numeric_idor "$url" "$project_id"

    # Test GUID/UUID manipulation
    test_guid_idor "$url" "$project_id"

    # Test filename manipulation
    test_filename_idor "$url" "$project_id"
}

# Test numeric ID parameter manipulation
test_numeric_idor() {
    local url=$1
    local project_id=$2

    log_info "[IDOR] Testing numeric ID manipulation"

    # Extract numeric parameters from URL
    local params=$(extract_url_parameters "$url")

    if [ -z "$params" ]; then
        log_debug "[IDOR] No parameters in URL"
        return 1
    fi

    while read -r param; do
        # Get parameter value
        local param_value=$(extract_param_value "$url" "$param")

        # Check if it's numeric
        if [[ "$param_value" =~ ^[0-9]+$ ]]; then
            log_debug "[IDOR] Testing numeric parameter: $param=$param_value"
            test_numeric_id_manipulation "$url" "$param" "$param_value" "$project_id"
        fi
    done <<< "$params"
}

# Test numeric ID manipulation for a specific parameter
test_numeric_id_manipulation() {
    local url=$1
    local param=$2
    local original_value=$3
    local project_id=$4

    # Get baseline response with original value
    local baseline_response=$(curl -s -L --max-time 10 "$url" 2>/dev/null)
    local baseline_length=${#baseline_response}
    local baseline_code=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 10 "$url" 2>/dev/null)

    # Test manipulation strategies
    local test_values=(
        $((original_value + 1))     # Next ID
        $((original_value - 1))     # Previous ID
        $((original_value + 10))    # Skip ahead
        1                           # First ID
        100                         # Common test ID
        9999                        # High ID
    )

    for test_value in "${test_values[@]}"; do
        # Skip if same as original
        [ "$test_value" = "$original_value" ] && continue
        [ "$test_value" -lt 1 ] && continue  # Skip negative/zero

        # Build test URL
        local test_url=$(replace_param_value "$url" "$param" "$test_value")

        log_debug "[IDOR] Testing $param=$test_value"

        # Send request
        local test_response=$(curl -s -L --max-time 10 "$test_url" 2>/dev/null)
        local test_length=${#test_response}
        local test_code=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 10 "$test_url" 2>/dev/null)

        # Check if we got a successful response with different content
        if [ "$test_code" = "200" ] && [ "$test_length" -gt 100 ]; then
            # Calculate difference
            local diff=$((baseline_length - test_length))
            [ $diff -lt 0 ] && diff=$((-diff))

            # If response is significantly different, likely accessing different resource
            if [ $diff -gt 50 ]; then
                log_critical "[IDOR] Potential IDOR vulnerability found in parameter '$param'!"

                # Check if response contains user/sensitive data indicators
                local has_sensitive_data=false
                if echo "$test_response" | grep -qiE "email|username|user_id|profile|account|password|address|phone|ssn|credit"; then
                    has_sensitive_data=true
                fi

                local severity="high"
                [ "$has_sensitive_data" = true ] && severity="critical"

                db_add_finding "$project_id" "$severity" "idor" \
                    "IDOR - Insecure Direct Object Reference in '$param'" \
                    "URL: $url\nParameter: $param\nOriginal Value: $original_value\nTest Value: $test_value\n\nOriginal response: HTTP $baseline_code, ${baseline_length} bytes\nTest response: HTTP $test_code, ${test_length} bytes\n\nBy manipulating the '$param' parameter, it's possible to access resources belonging to other users without proper authorization checks.\n\nSensitive data detected: $has_sensitive_data" \
                    "" "8.2" \
                    "1. Implement proper access control checks before serving resources\n2. Verify user ownership of requested resources\n3. Use indirect references (mapping IDs) instead of direct database IDs\n4. Implement role-based access control (RBAC)\n5. Use UUIDs instead of sequential integers\n6. Log and monitor access to sensitive resources"

                # Save evidence
                save_idor_evidence "$project_id" "$url" "$param" "$original_value" "$test_value" "$test_response"

                return 0
            fi
        elif [ "$test_code" = "403" ] || [ "$test_code" = "401" ]; then
            log_debug "[IDOR] Access properly restricted for $param=$test_value (HTTP $test_code)"
        fi
    done

    return 1
}

# Test GUID/UUID manipulation
test_guid_idor() {
    local url=$1
    local project_id=$2

    log_info "[IDOR] Testing GUID/UUID manipulation"

    # Extract parameters that look like GUIDs
    local params=$(extract_url_parameters "$url")

    if [ -z "$params" ]; then
        return 1
    fi

    while read -r param; do
        local param_value=$(extract_param_value "$url" "$param")

        # Check if it looks like a GUID/UUID
        if [[ "$param_value" =~ ^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$ ]]; then
            log_debug "[IDOR] Testing GUID parameter: $param"
            test_guid_manipulation "$url" "$param" "$param_value" "$project_id"
        elif [[ "$param_value" =~ ^[0-9a-fA-F]{32}$ ]]; then
            log_debug "[IDOR] Testing hash-like parameter: $param"
            test_guid_manipulation "$url" "$param" "$param_value" "$project_id"
        fi
    done <<< "$params"
}

# Test GUID manipulation for a specific parameter
test_guid_manipulation() {
    local url=$1
    local param=$2
    local original_value=$3
    local project_id=$4

    # Get baseline
    local baseline_response=$(curl -s -L --max-time 10 "$url" 2>/dev/null)
    local baseline_code=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 10 "$url" 2>/dev/null)

    # Common test GUIDs
    local test_guids=(
        "00000000-0000-0000-0000-000000000000"
        "11111111-1111-1111-1111-111111111111"
        "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"
        "ffffffff-ffff-ffff-ffff-ffffffffffff"
    )

    # Also try modifying last characters
    local modified_guid="${original_value:0:-1}0"
    test_guids+=("$modified_guid")

    for test_guid in "${test_guids[@]}"; do
        local test_url=$(replace_param_value "$url" "$param" "$test_guid")

        local test_code=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 10 "$test_url" 2>/dev/null)

        if [ "$test_code" = "200" ]; then
            local test_response=$(curl -s -L --max-time 10 "$test_url" 2>/dev/null)

            # Check if content is different
            if [ "$test_response" != "$baseline_response" ]; then
                log_warn "[IDOR] GUID parameter may be vulnerable to enumeration"

                db_add_finding "$project_id" "medium" "idor_guid" \
                    "Potential IDOR with GUID/UUID Parameter" \
                    "URL: $url\nParameter: $param\nOriginal: $original_value\nTest: $test_guid\n\nAlthough using GUIDs, the parameter may still be vulnerable to IDOR if GUIDs are predictable or enumerable." \
                    "" "6.5" \
                    "1. Implement proper authorization checks\n2. Verify user has permission to access the resource\n3. Use cryptographically random GUIDs (UUIDv4)\n4. Don't rely solely on GUID unpredictability for security"

                return 0
            fi
        fi
    done

    return 1
}

# Test filename manipulation (for file downloads, etc.)
test_filename_idor() {
    local url=$1
    local project_id=$2

    log_info "[IDOR] Testing filename parameter manipulation"

    # Look for file/filename/document parameters
    local file_params=("file" "filename" "document" "doc" "pdf" "download" "path" "name")

    for param in "${file_params[@]}"; do
        # Check if parameter exists in URL
        if echo "$url" | grep -qE "[?&]${param}="; then
            local param_value=$(extract_param_value "$url" "$param")

            if [ -n "$param_value" ]; then
                log_debug "[IDOR] Testing file parameter: $param=$param_value"
                test_file_manipulation "$url" "$param" "$param_value" "$project_id"
            fi
        fi
    done
}

# Test file parameter manipulation
test_file_manipulation() {
    local url=$1
    local param=$2
    local original_value=$3
    local project_id=$4

    # Sensitive files to test
    local test_files=(
        "/etc/passwd"
        "../../etc/passwd"
        "../../../etc/passwd"
        "..\\..\\..\\windows\\system32\\config\\sam"
        "/admin/config.php"
        "/admin/users.csv"
        "users.csv"
        "config.php"
        ".env"
        "database.yml"
        "credentials.json"
    )

    for test_file in "${test_files[@]}"; do
        local test_url=$(replace_param_value "$url" "$param" "$test_file")

        local response=$(curl -s -L --max-time 10 -w "\n---HTTP_CODE:%{http_code}---" "$test_url" 2>/dev/null)
        local body=$(echo "$response" | sed -n '1,/---HTTP_CODE:/p' | head -n -1)
        local code=$(echo "$response" | grep -oP '---HTTP_CODE:\K\d+')

        if [ "$code" = "200" ] && [ -n "$body" ]; then
            # Check for signs of file disclosure
            if echo "$body" | grep -qE "root:|admin|password|secret|key"; then
                log_critical "[IDOR] File disclosure vulnerability found via parameter manipulation!"

                db_add_finding "$project_id" "critical" "idor_file_disclosure" \
                    "IDOR - Arbitrary File Disclosure" \
                    "URL: $test_url\nParameter: $param\nTest File: $test_file\n\nSuccessfully accessed sensitive file by manipulating the '$param' parameter.\n\nThis may allow an attacker to read arbitrary files from the server." \
                    "" "9.1" \
                    "1. Implement strict whitelist of allowed files\n2. Never use user input directly in file paths\n3. Use file IDs mapped to actual paths server-side\n4. Validate file paths and reject path traversal attempts\n5. Implement proper access control for file downloads\n6. Store files outside web root"

                save_idor_evidence "$project_id" "$test_url" "$param" "$original_value" "$test_file" "$body"

                return 0
            fi
        fi
    done

    return 1
}

# Helper: Extract URL parameters
extract_url_parameters() {
    local url=$1

    if [[ "$url" != *"?"* ]]; then
        return 1
    fi

    local query_string="${url#*\?}"
    echo "$query_string" | tr '&' '\n' | cut -d= -f1
}

# Helper: Extract parameter value
extract_param_value() {
    local url=$1
    local param=$2

    echo "$url" | grep -oP "[?&]${param}=\K[^&]+"
}

# Helper: Replace parameter value
replace_param_value() {
    local url=$1
    local param=$2
    local new_value=$3

    echo "$url" | sed "s/\([?&]${param}=\)[^&]*/\1${new_value}/"
}

# Helper: Save IDOR evidence
save_idor_evidence() {
    local project_id=$1
    local url=$2
    local param=$3
    local original_value=$4
    local test_value=$5
    local response=$6

    local evidence_dir="data/projects/${project_id}/evidence/idor"
    mkdir -p "$evidence_dir"

    local timestamp=$(date +%Y%m%d_%H%M%S)
    local evidence_file="${evidence_dir}/idor_${param}_${timestamp}.txt"

    cat > "$evidence_file" <<EOF
IDOR Evidence
URL: $url
Parameter: $param
Original Value: $original_value
Test Value: $test_value
Captured: $(date)

Response:
$response
EOF

    log_debug "[IDOR] Evidence saved to: $evidence_file"
}

# Export functions
export -f test_idor
export -f test_numeric_idor
export -f test_guid_idor
export -f test_filename_idor
