#!/bin/bash

# XSS Testing Module - Simplified Version
# Uses external tools (dalfox, nuclei) instead of manual testing

source "$(dirname "${BASH_SOURCE[0]}")/../../core/logger.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../../core/database.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../../core/http_helper.sh"

# Main XSS testing function
test_xss() {
    local url=$1
    local project_id=$2

    log_info "Testing XSS vulnerabilities on $url"

    # Try dalfox first (specialized XSS scanner)
    if command -v dalfox &> /dev/null; then
        test_xss_dalfox "$url" "$project_id"
    else
        log_debug "[XSS] dalfox not available, using nuclei XSS templates"
        test_xss_nuclei "$url" "$project_id"
    fi
}

# Test XSS using dalfox
test_xss_dalfox() {
    local url=$1
    local project_id=$2

    log_info "[XSS] Running dalfox XSS scanner"

    local output_file="/tmp/dalfox_${project_id}_$(date +%s).txt"

    # Run dalfox with various options
    dalfox url "$url" \
        --silence \
        --format plain \
        --output "$output_file" \
        --worker 10 \
        --timeout 10 \
        2>/dev/null

    # Parse results
    if [ -f "$output_file" ] && [ -s "$output_file" ]; then
        parse_dalfox_output "$output_file" "$project_id"
    else
        log_debug "[XSS] No XSS vulnerabilities found by dalfox"
    fi

    # Cleanup
    rm -f "$output_file"
}

# Test XSS using nuclei XSS templates
test_xss_nuclei() {
    local url=$1
    local project_id=$2

    log_info "[XSS] Running nuclei XSS templates"

    local output_file="/tmp/nuclei_xss_${project_id}_$(date +%s).txt"

    # Run nuclei with XSS-specific templates
    nuclei -u "$url" \
        -t ~/nuclei-templates/vulnerabilities/xss/ \
        -t ~/nuclei-templates/cves/ \
        -severity critical,high,medium \
        -silent \
        -o "$output_file" \
        2>/dev/null

    # Parse results
    if [ -f "$output_file" ] && [ -s "$output_file" ]; then
        while IFS= read -r line; do
            # Nuclei format: [template-id] [severity] URL
            if echo "$line" | grep -qiE "xss|cross.*site"; then
                local severity="high"
                local title=$(echo "$line" | cut -d']' -f2- | awk '{print $1" "$2" "$3}')

                db_add_finding "$project_id" "$severity" "xss" \
                    "XSS vulnerability detected" \
                    "URL: $url\n\nNuclei detected a potential XSS vulnerability:\n$line" \
                    "" "7.5" \
                    "Implement proper output encoding and Content Security Policy headers"

                log_warning "[XSS] Cross-Site Scripting vulnerability found"
            fi
        done < "$output_file"
    else
        log_debug "[XSS] No XSS vulnerabilities found by nuclei"
    fi

    # Cleanup
    rm -f "$output_file"
}

# Parse dalfox output
parse_dalfox_output() {
    local output_file=$1
    local project_id=$2

    local xss_count=0

    while IFS= read -r line; do
        # Skip empty lines and headers
        [ -z "$line" ] && continue
        [[ "$line" == "---"* ]] && continue

        # Parse dalfox findings
        if echo "$line" | grep -qE "^\[.*\]"; then
            ((xss_count++))

            local severity="high"
            local param=$(echo "$line" | grep -oE "Param: [^]]*" | cut -d' ' -f2-)
            local payload=$(echo "$line" | grep -oE "Payload: .*" | cut -d' ' -f2-)
            local vulnerable_url=$(echo "$line" | grep -oE "https?://[^ ]*" | head -1)

            db_add_finding "$project_id" "$severity" "xss_reflected" \
                "Reflected XSS in parameter: $param" \
                "A reflected XSS vulnerability was detected.\n\nVulnerable URL: $vulnerable_url\nParameter: $param\nPayload: $payload\n\nThe application reflects user input without proper sanitization." \
                "" "7.5" \
                "Implement proper output encoding based on context and use Content Security Policy headers"

            log_warning "[XSS] Reflected XSS found in parameter: $param"
        fi
    done < "$output_file"

    if [ $xss_count -gt 0 ]; then
        log_success "[XSS] Found $xss_count XSS vulnerabilities"
    fi
}

# Fallback functions for compatibility
test_reflected_xss() {
    test_xss "$@"
}

test_stored_xss() {
    log_debug "[XSS] Stored XSS testing requires manual verification with dalfox/nuclei"
}

test_dom_xss() {
    log_debug "[XSS] DOM XSS testing requires manual verification with dalfox/nuclei"
}

# Export functions
export -f test_xss
export -f test_xss_dalfox
export -f test_xss_nuclei
export -f parse_dalfox_output
export -f test_reflected_xss
export -f test_stored_xss
export -f test_dom_xss
