#!/bin/bash

# Vulnerability Testing Orchestrator
# Coordinates all vulnerability testing modules

source "$(dirname "${BASH_SOURCE[0]}")/../core/logger.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../core/database.sh"

# Load all vulnerability modules
# Using simplified XSS module that uses external tools (dalfox/nuclei)
source "$(dirname "${BASH_SOURCE[0]}")/../modules/vulnerability_tests/xss_module_simple.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../modules/vulnerability_tests/sqli_module.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../modules/vulnerability_tests/csrf_module.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../modules/vulnerability_tests/idor_module.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../modules/vulnerability_tests/rce_module.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../modules/vulnerability_tests/lfi_rfi_module.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../modules/vulnerability_tests/xxe_module.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../modules/vulnerability_tests/ssrf_module.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../modules/vulnerability_tests/xspa_module.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../modules/vulnerability_tests/cors_module.sh"

# Main vulnerability testing pipeline
vulnerability_testing_pipeline() {
    local target=$1
    local project_id=$2
    local test_type=${3:-"all"}  # all, injection, auth, config

    log_section "Vulnerability Testing Pipeline"
    log_info "Target: $target"
    log_info "Test Type: $test_type"

    # Get fuzzed endpoints from database
    local endpoints=$(db_execute "SELECT url FROM targets WHERE project_id=$project_id AND (tag='fuzzed_endpoint' OR tag='high_value_endpoint') AND autopilot_status='pending' LIMIT 50" 2>/dev/null)

    # If no fuzzed endpoints, use the main target
    if [ -z "$endpoints" ]; then
        endpoints="$target"
    fi

    local total_endpoints=$(echo "$endpoints" | wc -l)
    local current=0

    log_info "Testing $total_endpoints endpoints"

    echo "$endpoints" | while read -r endpoint; do
        [ -z "$endpoint" ] && continue

        current=$((current + 1))
        log_info "[$current/$total_endpoints] Testing: $endpoint"

        # Mark as in progress
        db_execute "UPDATE targets SET autopilot_status='in_progress' WHERE url='$endpoint' AND project_id=$project_id" 2>/dev/null

        case "$test_type" in
            "all")
                test_all_vulnerabilities "$endpoint" "$project_id"
                ;;
            "injection")
                test_injection_flaws "$endpoint" "$project_id"
                ;;
            "auth")
                test_auth_flaws "$endpoint" "$project_id"
                ;;
            "config")
                test_config_issues "$endpoint" "$project_id"
                ;;
        esac

        # Mark as completed
        db_execute "UPDATE targets SET autopilot_status='completed' WHERE url='$endpoint' AND project_id=$project_id" 2>/dev/null

        # Small delay between endpoints
        sleep 1
    done

    # Generate vulnerability testing report
    generate_vuln_test_report "$project_id"

    log_success "Vulnerability testing pipeline completed"
}

# Test all vulnerability types
test_all_vulnerabilities() {
    local url=$1
    local project_id=$2

    log_info "[VulnTest] Comprehensive testing: $url"

    # Injection flaws (parallel)
    # XSS now uses external tools (dalfox/nuclei) - no more syntax issues!
    (test_xss "$url" "$project_id") &
    (test_sqli "$url" "$project_id") &
    (test_xxe "$url" "$project_id") &
    (test_rce "$url" "$project_id") &
    (test_lfi_rfi "$url" "$project_id") &

    wait  # Wait for injection tests to complete

    # Authentication and access control
    test_csrf "$url" "$project_id"
    test_idor "$url" "$project_id"

    # Server-side vulnerabilities
    (test_ssrf "$url" "$project_id") &
    (test_xspa "$url" "$project_id") &

    wait

    # Configuration issues
    test_cors "$url" "$project_id"
}

# Test only injection flaws
test_injection_flaws() {
    local url=$1
    local project_id=$2

    log_info "[VulnTest] Testing injection flaws: $url"

    test_xss "$url" "$project_id"
    test_sqli "$url" "$project_id"
    test_xxe "$url" "$project_id"
    test_rce "$url" "$project_id"
    test_lfi_rfi "$url" "$project_id"
}

# Test authentication and authorization flaws
test_auth_flaws() {
    local url=$1
    local project_id=$2

    log_info "[VulnTest] Testing authentication/authorization: $url"

    test_csrf "$url" "$project_id"
    test_idor "$url" "$project_id"
}

# Test configuration issues
test_config_issues() {
    local url=$1
    local project_id=$2

    log_info "[VulnTest] Testing configuration issues: $url"

    test_cors "$url" "$project_id"
    test_ssrf "$url" "$project_id"
}

# Generate vulnerability test report
generate_vuln_test_report() {
    local project_id=$1

    local report_file="data/projects/${project_id}/scans/vulnerability_test_report.txt"
    mkdir -p "$(dirname "$report_file")"

    cat > "$report_file" <<EOF
========================================================
Vulnerability Testing Report
========================================================
Date: $(date)
Project ID: $project_id

Summary:
--------
EOF

    # Count findings by severity
    local critical=$(db_execute "SELECT COUNT(*) FROM findings WHERE project_id=$project_id AND severity='critical'" 2>/dev/null | tail -1)
    local high=$(db_execute "SELECT COUNT(*) FROM findings WHERE project_id=$project_id AND severity='high'" 2>/dev/null | tail -1)
    local medium=$(db_execute "SELECT COUNT(*) FROM findings WHERE project_id=$project_id AND severity='medium'" 2>/dev/null | tail -1)
    local low=$(db_execute "SELECT COUNT(*) FROM findings WHERE project_id=$project_id AND severity='low'" 2>/dev/null | tail -1)

    echo "Critical: $critical" >> "$report_file"
    echo "High: $high" >> "$report_file"
    echo "Medium: $medium" >> "$report_file"
    echo "Low: $low" >> "$report_file"
    echo "" >> "$report_file"

    # Count by vulnerability type
    echo "Vulnerability Types Found:" >> "$report_file"
    echo "-------------------------" >> "$report_file"

    db_execute "SELECT type, severity, COUNT(*) as count FROM findings WHERE project_id=$project_id GROUP BY type, severity ORDER BY \
                CASE severity \
                    WHEN 'critical' THEN 1 \
                    WHEN 'high' THEN 2 \
                    WHEN 'medium' THEN 3 \
                    WHEN 'low' THEN 4 \
                    ELSE 5 \
                END, count DESC" 2>/dev/null | while read -r type severity count; do
        echo "  $type ($severity): $count" >> "$report_file"
    done

    echo "" >> "$report_file"
    echo "Detailed findings available in database and markdown reports." >> "$report_file"

    log_success "Vulnerability test report: $report_file"
}

# Export functions
export -f vulnerability_testing_pipeline
export -f test_all_vulnerabilities
export -f test_injection_flaws
export -f test_auth_flaws
export -f test_config_issues
